name: Deploy to Dev (Local)

# Triggers
on:
  push:
    branches: [main, dev]
    paths:
      - 'k8s/**'
      - '.github/workflows/deploy-dev.yml'
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Confirm deploy to dev? (Type "yes")'
        required: true
        type: string

# Melhor prÃ¡tica: Only deploy on explicit confirmation
concurrency:
  group: deploy-dev
  cancel-in-progress: false  # NÃ£o cancelar deploys em andamento

jobs:
  # Job 1: Pre-flight checks
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Kubernetes manifests
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          
          # Validate manifests
          kubectl apply --dry-run=server -f k8s/base/
          
      - name: Check for secrets in manifests
        run: |
          # Melhor prÃ¡tica: nÃ£o versionar secrets
          if grep -r "secret" k8s/base/ --include="*.yaml"; then
            echo "âŒ ERROR: Secrets found in manifests!"
            echo "ðŸ’¡ Use k8s/secrets/ for secrets (not versioned)"
            exit 1
          else
            echo "âœ… No secrets found in manifests"
          fi

  # Job 2: Deploy to Dev (Self-Hosted Runner)
  deploy-dev:
    name: Deploy to Dev (Local)
    runs-on: self-hosted  # âœ… Roda na sua mÃ¡quina local
    timeout-minutes: 10
    needs: preflight
    environment:
      name: dev
      url: http://localhost:30474  # Neo4j browser
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify K3S connection
        run: |
          # Melhor prÃ¡tica: verificar se K3S estÃ¡ rodando
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          
          if ! k3s kubectl cluster-info; then
            echo "âŒ ERROR: K3S is not running!"
            exit 1
          fi
          
          echo "âœ… K3S is running"

      - name: Deploy manifests to K3S
        run: |
          # Melhor prÃ¡tica: usar Kustomize para gerenciamento de configs
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          
          # Aplicar manifests base
          k3s kubectl apply -f k8s/base/namespace.yaml
          
          # Aplicar secrets (do K8S secrets, nÃ£o do git)
          # k3s kubectl apply -f k8s/secrets/
          
          # Aplicar Neo4j
          k3s kubectl apply -f k8s/base/neo4j/
          
          # Aplicar LocalAI
          k3s kubectl apply -f k8s/base/localai/

      - name: Verify deployments
        run: |
          # Melhor prÃ¡tica: verificar se deployments estÃ£o funcionando
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          
          # Aguardar rollout do Neo4j
          k3s kubectl rollout status deployment/neo4j -n neo4j-langraph --timeout=300s
          
          # Aguardar rollout do LocalAI
          k3s kubectl rollout status deployment/localai -n neo4j-langraph --timeout=300s
          
          echo "âœ… All deployments rolled out successfully"

      - name: Verify pods
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          
          # Listar pods
          echo "ðŸ“Š Pods in neo4j-langraph namespace:"
          k3s kubectl get pods -n neo4j-langraph
          
          # Verificar se todos os pods estÃ£o rodando
          NOT_RUNNING=$(k3s kubectl get pods -n neo4j-langraph --field-selector=status.phase!=Running -o name | wc -l)
          
          if [ "$NOT_RUNNING" -gt 0 ]; then
            echo "âŒ ERROR: $NOT_RUNNING pods are not running!"
            exit 1
          fi
          
          echo "âœ… All pods are running"

      - name: Verify services
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          
          echo "ðŸ“Š Services in neo4j-langraph namespace:"
          k3s kubectl get svc -n neo4j-langraph
          
          # Verificar se Neo4j estÃ¡ acessÃ­vel
          NEO4J_SVC=$(k3s kubectl get svc neo4j -n neo4j-langraph -o jsonpath='{.spec.type}')
          echo "âœ… Neo4j service type: $NEO4J_SVC"

      - name: Health checks
        run: |
          # Melhor prÃ¡tica: executar health checks
          
          # Test Neo4j
          echo "1ï¸âƒ£  Testing Neo4j connection..."
          NEO4J_POD=$(k3s kubectl get pods -n neo4j-langraph -l app=neo4j -o jsonpath='{.items[0].metadata.name}')
          
          if k3s kubectl exec -n neo4j-langraph $NEO4J_POD -- \
            cypher-shell -u neo4j -p password "RETURN 1 AS num"; then
            echo "âœ… Neo4j connection successful"
          else
            echo "âŒ ERROR: Neo4j connection failed!"
            exit 1
          fi
          
          # Test LocalAI
          echo ""
          echo "2ï¸âƒ£  Testing LocalAI connection..."
          LOCALAI_POD=$(k3s kubectl get pods -n neo4j-langraph -l app=localai -o jsonpath='{.items[0].metadata.name}')
          
          if k3s kubectl exec -n neo4j-langraph $LOCALAI_POD -- \
            wget -O- http://localhost:8080/health; then
            echo "âœ… LocalAI connection successful"
          else
            echo "âŒ ERROR: LocalAI connection failed!"
            exit 1
          fi

      - name: Create deployment report
        run: |
          # Melhor prÃ¡tica: gerar relatÃ³rio de deploy
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          
          cat > deployment-report.txt << 'EOF'
          ====================
          DEPLOYMENT REPORT
          ====================
          
          Environment: dev
          Date: $(date)
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref }}
          
          Deployments:
          $(k3s kubectl get deployments -n neo4j-langraph)
          
          Pods:
          $(k3s kubectl get pods -n neo4j-langraph)
          
          Services:
          $(k3s kubectl get svc -n neo4j-langraph)
          ====================
          EOF
          
          cat deployment-report.txt

      - name: Upload deployment report
        uses: actions/upload-artifact@v3
        with:
          name: deployment-report-dev
          path: deployment-report.txt
          retention-days: 30

      - name: Notify on success
        if: success()
        run: |
          echo "ðŸŽ‰ DEPLOY TO DEV SUCCESSFUL!"
          echo "ðŸ“Š Neo4j Browser: http://localhost:30474"
          echo "ðŸ¤– LocalAI: http://localhost:30808"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ DEPLOY TO DEV FAILED!"
          echo "ðŸ’¡ Check logs:"
          echo "   k3s kubectl logs deployment/neo4j -n neo4j-langraph"
          echo "   k3s kubectl logs deployment/localai -n neo4j-langraph"
